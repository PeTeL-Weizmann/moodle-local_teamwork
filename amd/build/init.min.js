define(["jquery","core/str","core/ajax","local_teamwork/popup","local_teamwork/render","local_teamwork/dragula","local_teamwork/skin","local_teamwork/loading","core/notification"],function(e,t,a,r,o,n,s,d,l){"use strict";const i=document.querySelector("body"),u=(e,t,o,n)=>{a.call([{methodname:"local_teamwork_set_teamwork_enable",args:{activityid:Number(t),moduletype:o},done:function(e){n(e)},fail:function(){r.error()}}])},c=(e,t,o,n)=>{n.checked;a.call([{methodname:"local_teamwork_set_access_to_student",args:{activityid:Number(t),moduletype:o},done:function(e){},fail:function(){r.error()}}])},m=(e,t,o,n,s)=>{d.show(),a.call([{methodname:"local_teamwork_add_new_card",args:{courseid:Number(e),activityid:Number(t),moduletype:o,selectgroupid:n},done:function(e){d.remove(),s(e)},fail:function(){d.remove(),r.error()}}])},_=(e,t,o,n,s)=>{d.show(),a.call([{methodname:"local_teamwork_delete_card",args:{teamid:e},done:function(e){d.remove(),s(e)},fail:function(){d.remove(),r.error()}}])},f=()=>{const e=document.querySelector("#teamuserallowenddate"),t=Array.from(document.querySelectorAll(".teamuserenddate-inputs-wrapper input, .teamuserenddate-inputs-wrapper select"));e.addEventListener("change",e=>{e.target.checked?(t.forEach(e=>{e.removeAttribute("disabled")}),e.target.value="1"):(t.forEach(e=>{e.setAttribute("disabled","disabled")}),e.target.value="0")})},v=(e,t)=>{a.call([{methodname:"local_teamwork_render_student_settings_popup",args:{activityid:e,moduletype:t},done:function(e){let t=JSON.parse(e.result);r.textHead=t.header,r.text=t.content,r.show(),setTimeout(f,1e3)},fail:function(){r.error()}}])},p=(e,t,o)=>{const n=document.querySelector(".teamwork-modal"),s=n.querySelector("#teamnumbers").value,l=n.querySelector("#teamusernumbers").value,i=n.querySelector("input[name=team-userend-date]").value,u=n.querySelector("select[name=team-userend-month]").value,c=n.querySelector("input[name=team-userend-year]").value,m=n.querySelector("input[name=team-userend-hour]").value,_=n.querySelector("input[name=team-userend-minute]").value,f=n.querySelector("input[name=teamuserallowenddate]").value;d.show(),a.call([{methodname:"local_teamwork_student_settings_popup_data",args:{courseid:Number(e),activityid:Number(t),moduletype:o,teamnumbers:Number(s),teamusernumbers:Number(l),teamuserenddate:Number(i),teamuserendmonth:Number(u),teamuserendyear:Number(c),teamuserendhour:Number(m),teamuserendminute:Number(_),teamuserallowenddate:Number(f)},done:function(e){d.remove()},fail:function(){r.error()}}])},h=(e,t,o,n,s,l)=>{for(;!e.classList.contains("teamwork-modal");)e=e.parentNode;const i=e.querySelector("#student_number").value;d.show(),a.call([{methodname:"local_teamwork_set_random_teams",args:{courseid:Number(t),activityid:Number(o),moduletype:n,selectgroupid:s,numberofstudent:Number(i)},done:function(e){d.remove(),l(e)},fail:function(){d.remove(),r.error()}}])},g=()=>{const e=i.querySelector('input[data-handler = "search_student"]');e.addEventListener("input",function(t){(e=>{const t=Array.from(document.querySelectorAll("#studentList div[data-student_id]")),a=e.value;a?t.forEach(e=>{e.innerHTML.toLowerCase().search(a.toLowerCase())>=0?e.classList.remove("visuallyhidden"):e.classList.add("visuallyhidden")}):t.forEach(e=>{e.classList.remove("visuallyhidden")})})(e)})},y=e=>{const t=Array.from(document.querySelectorAll("#studentList div[data-student_id]"));i.querySelector('input[data-handler = "search_student"]').value="",t.forEach(e=>{e.classList.remove("visuallyhidden")})};return{init:function(t,r,o,n){var s=this;a.call([{methodname:"local_teamwork_render_block_html_page",args:{courseid:Number(t),activityid:Number(r),moduletype:o,selectgroupid:n},done:function(a){e("body#page-mod-assign-view #intro").append(a.result),s.renderHtmlToPage(t,r,o,n)},fail:l.exception}])},renderHtmlToPage:function(t,d,l,f){o.data={sesskey:M.cfg.sesskey,courseid:t,activityid:d,moduletype:l,selectgroupid:f},e("#open_local").on("click",function(){o.mainBlock(g)}),document.addEventListener("click",function(n){let g=n.target;for(;g!==i;){if("teamwork_toggle"===g.dataset.handler)return g.classList.toggle("active"),e(".skin_shadow").toggleClass("skin_show"),e(".skin_shadow").toggleClass("skin_hide"),void u(0,d,l);if(g.classList.contains("close_popup")||g.classList.contains("teamwork-modal_close")){if(g.classList.contains("stop-close"))return;return void r.remove()}if(g.classList.contains("skin_close"))return void s.remove();if("access_to_student"===g.dataset.handler&&(g.classList.contains("active")?(g.classList.remove("active"),c(0,d,l,g)):(g.classList.add("active"),v(d,l),c(0,d,l,g))),"get_popup_data"===g.dataset.handler)return n.preventDefault(),p(t,d,l),void r.remove();if("open_group_selection"===g.dataset.handler)return void e(g).next().slideToggle();if("select_groups"===g.dataset.handler){let t=document.querySelector('html[lang="en"]')?"choose grous":"בחר קבוצה";if(g.classList.contains("selected"))return;g.classList.toggle("selected"),e('div[data-handler="open_group_selection"]').html(g.classList.contains("selected")?g.innerHTML:t),e(g).siblings().removeClass("selected");let a=[];return Array.from(g.parentNode.children).forEach(e=>{e.classList.contains("selected")&&a.push(e.dataset.value)}),e(g).parent().slideToggle(),f=JSON.stringify(a),o.data.selectgroupid=JSON.stringify(a),o.studentList(),void o.teamsCard()}if("add_new_teamcard"===g.dataset.handler)return void m(t,d,l,f,function(){o.setDefaultData(),o.studentList(),o.teamsCard()});if("delete_teamcard"===g.dataset.handler){let e=g.dataset.remove_team_id;return void _(e,0,0,0,function(){o.setDefaultData(),o.teamsCard(),o.studentList()})}if("random_popup"===g.dataset.handler)return void a.call([{methodname:"local_teamwork_show_random_popup",args:{},done:function(e){let t=JSON.parse(e.result);r.textHead=t.header,r.text=t.content,r.show()},fail:function(){r.error()}}]);if("random"===g.dataset.handler)return void h(g,t,d,l,o.data.selectgroupid,function(){o.teamsCard(),o.studentList(),r.remove()});if("search_reset"===g.dataset.handler)return void y();g=g.parentNode}}),n.startDrag(),document.addEventListener("change",function(e){"input_team_name"===e.target.dataset.handler&&(e=>{const t=e.dataset.team_id,o=e.value;a.call([{methodname:"local_teamwork_set_new_team_name",args:{cardid:Number(t),cardname:o},done:function(e){},fail:function(){r.error()}}])})(e.target)}),document.addEventListener("keydown",function(e){27===e.keyCode&&(s.remove(),r.remove())})}}});