define("local_teamwork/init",["jquery","core/str","core/ajax","core/modal_factory","core/modal_events","local_teamwork/popup","local_teamwork/render","local_teamwork/dragula","local_teamwork/skin","local_teamwork/loading","local_teamwork/voicecontrol","local_teamwork/keyboardnav","core/notification"],(function($,Str,Ajax,ModalFactory,ModalEvents,popup,render,drag,skin,loadingIcon,Voicecontrol,Keyboardnav,Notification){const mainBlock=document.querySelector("body");const set_teamwork_enable=(courseid,activityid,moduletype,callback)=>{Ajax.call([{methodname:"local_teamwork_set_teamwork_enable",args:{activityid:Number(activityid),moduletype:moduletype},done:function(data){callback(data)},fail:function(){popup.error()}}])},set_access_to_student=(courseid,activityid,moduletype,target)=>{target.checked;Ajax.call([{methodname:"local_teamwork_set_access_to_student",args:{activityid:Number(activityid),moduletype:moduletype},done:function(data){},fail:function(){popup.error()}}])},add_new_card=function(courseid,activityid,moduletype,selectgroupid){let teamname=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,callback=arguments.length>5?arguments[5]:void 0;loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_add_new_card",args:{courseid:Number(courseid),activityid:Number(activityid),moduletype:moduletype,selectgroupid:selectgroupid,teamname:teamname},done:function(data){loadingIcon.remove(),callback(data)},fail:function(){loadingIcon.remove(),popup.error()}}])},delete_card=(teamid,courseid,activityid,moduletype,callback)=>{loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_delete_card",args:{teamid:teamid},done:function(data){loadingIcon.remove(),callback(data)},fail:function(){loadingIcon.remove(),popup.error()}}])},delete_user_submit=(userid,teamid,courseid,activityid,moduletype,callback)=>{loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_delete_user_submit",args:{userid:userid,teamid:teamid,courseid:Number(courseid),activityid:Number(activityid),moduletype:moduletype},done:function(data){loadingIcon.remove(),callback(data)},fail:function(){loadingIcon.remove(),popup.error()}}])},student_settings_enddate_state=()=>{const teamuserallowenddatechkbox=document.querySelector("#teamuserallowenddate"),allinputs=Array.from(document.querySelectorAll(".teamuserenddate-inputs-wrapper input, .teamuserenddate-inputs-wrapper select"));teamuserallowenddatechkbox.addEventListener("change",(e=>{e.target.checked?(allinputs.forEach((item=>{item.removeAttribute("disabled")})),e.target.value="1"):(allinputs.forEach((item=>{item.setAttribute("disabled","disabled")})),e.target.value="0"),Keyboardnav.getFocusableElements(".teamwork-modal"),Keyboardnav.setAccessabilityBehaviuor()}))},render_student_settings_popup=(activityid,moduletype)=>{Ajax.call([{methodname:"local_teamwork_render_student_settings_popup",args:{activityid:activityid,moduletype:moduletype},done:function(data){let result=JSON.parse(data.result);popup.textHead=result.header,popup.text=result.content,popup.show(),Keyboardnav.getFocusableElements(".teamwork-modal"),Keyboardnav.setAccessabilityBehaviuor(),Keyboardnav.setFocusOnElement("#teamnumbers"),setTimeout(student_settings_enddate_state,1e3)},fail:function(){popup.error()}}])},student_settings_popup_data=(courseid,activityid,moduletype)=>{const popupForm=document.querySelector(".teamwork-modal"),teamNumbers=popupForm.querySelector("#teamnumbers").value,teamUserNumbers=popupForm.querySelector("#teamusernumbers").value,teamUserendDate=popupForm.querySelector("input[name=team-userend-date]").value,teamUserendMonth=popupForm.querySelector("select[name=team-userend-month]").value,teamUserendYear=popupForm.querySelector("input[name=team-userend-year]").value,teamUserendHour=popupForm.querySelector("input[name=team-userend-hour]").value,teamUserendMinute=popupForm.querySelector("input[name=team-userend-minute]").value,teamuserallowenddate=popupForm.querySelector("input[name=teamuserallowenddate]").value;loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_student_settings_popup_data",args:{courseid:Number(courseid),activityid:Number(activityid),moduletype:moduletype,teamnumbers:Number(teamNumbers),teamusernumbers:Number(teamUserNumbers),teamuserenddate:Number(teamUserendDate),teamuserendmonth:Number(teamUserendMonth),teamuserendyear:Number(teamUserendYear),teamuserendhour:Number(teamUserendHour),teamuserendminute:Number(teamUserendMinute),teamuserallowenddate:Number(teamuserallowenddate)},done:function(data){loadingIcon.remove()},fail:function(){popup.error()}}])},set_random_teams=(target,courseid,activityid,moduletype,selectgroupid,callback)=>{for(;!target.classList.contains("teamwork-modal");)target=target.parentNode;const numberofstudent=target.querySelector("#student_number").value;loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_set_random_teams",args:{courseid:Number(courseid),activityid:Number(activityid),moduletype:moduletype,selectgroupid:selectgroupid,numberofstudent:Number(numberofstudent)},done:function(data){loadingIcon.remove(),callback(data)},fail:function(){loadingIcon.remove(),popup.error()}}])},set_new_team_name=(target,courseid,activityid,moduletype,selectgroupid,callback)=>{const cardid=target.dataset.team_id,cardname=target.value;Ajax.call([{methodname:"local_teamwork_set_new_team_name",args:{cardid:Number(cardid),cardname:cardname},done:function(data){callback()},fail:function(){popup.error()}}])},searchInit=()=>{const searchInput=mainBlock.querySelector('input[data-handler = "search_student"]');searchInput.addEventListener("input",(function(e){(target=>{const studentList=Array.from(document.querySelectorAll("#studentList div[data-student_id]")),searchItem=target.value;searchItem?studentList.forEach((item=>{item.innerHTML.toLowerCase().search(searchItem.toLowerCase())>=0?item.classList.remove("visuallyhidden"):item.classList.add("visuallyhidden")})):studentList.forEach((item=>{item.classList.remove("visuallyhidden")}))})(searchInput)}))},searchReset=target=>{const studentList=Array.from(document.querySelectorAll("#studentList div[data-student_id]"));mainBlock.querySelector('input[data-handler = "search_student"]').value="",studentList.forEach((item=>{item.classList.remove("visuallyhidden")}))};return{add_new_card:function(courseid,activityid,moduletype,selectgroupid,teamname,callback){add_new_card(courseid,activityid,moduletype,selectgroupid,teamname,callback)},delete_card:function(teamid,courseid,activityid,moduletype,callback){delete_card(teamid,0,0,0,callback)},init:function(courseid,activityid,moduletype,selectgroupid){let self=this,voice=0;Ajax.call([{methodname:"local_teamwork_render_block_html_page",args:{courseid:Number(courseid),activityid:Number(activityid),moduletype:moduletype,selectgroupid:selectgroupid},done:function(data){let paths=JSON.parse(data.paths),tokens=JSON.parse(data.tokens),schemes=JSON.parse(data.schemes);if(voice=data.voicecontrolenabled,0!==voice&&(Voicecontrol.init(data.currentlangcode,paths,tokens,schemes),Voicecontrol.reload(courseid,activityid,moduletype,selectgroupid,paths,data.currentlangcode)),"assign"===moduletype){$("body#page-mod-assign-view #intro").append(data.html),self.renderHtmlToPage(courseid,activityid,moduletype,selectgroupid)}if("quiz"===moduletype){$(".quizinfo").append(data.html),self.renderHtmlToPage(courseid,activityid,moduletype,selectgroupid)}},fail:Notification.exception}])},renderHtmlToPage:function(courseid,activityid,moduletype,selectgroupid){render.data={sesskey:M.cfg.sesskey,courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid},$("#open_local").on("click",(function(){render.mainBlock(searchInit,false)})),document.addEventListener("click",(function(event){let target=event.target;for(event.stopPropagation();target!==mainBlock&&null!==target;){if("teamwork_toggle"===target.dataset.handler){target.classList.toggle("active");let state="active"===target.dataset.state?"disabled":"active";return target.dataset.state=state,target.setAttribute("aria-pressed",state),$(".skin_shadow").toggleClass("skin_show").toggleClass("skin_hide"),skin.checkPopupSkinState(state),"disabled"===state?Keyboardnav.getFocusableElements(".teamworkdialog",'[data-handler="teamwork_toggle"], .skin_close'):Keyboardnav.getFocusableElements(".teamworkdialog"),Keyboardnav.setFocusOnElement('[data-handler="teamwork_toggle"]'),Keyboardnav.setAccessabilityBehaviuor(),void set_teamwork_enable(0,activityid,moduletype,(function(){}))}if(target.classList.contains("close_popup")||target.classList.contains("teamwork-modal_close")){if(target.classList.contains("stop-close"))return;return popup.remove(),target.classList.contains("teamwork-modal_close")?(Keyboardnav.getFocusableElements(".teamworkdialog"),Keyboardnav.setAccessabilityBehaviuor(),void Keyboardnav.setFocusOnPrevfocusedElement()):void 0}if(target.classList.contains("skin_close")||target.classList.contains("close_btn"))return Voicecontrol.stop(),void skin.remove();if("access_to_student"===target.dataset.handler&&(target.classList.contains("active")?(target.classList.remove("active"),set_access_to_student(0,activityid,moduletype,target)):(target.classList.add("active"),render_student_settings_popup(activityid,moduletype),Keyboardnav.setPrevfocusedElement('[data-handler="'.concat(target.dataset.handler,'"]')),set_access_to_student(0,activityid,moduletype,target))),"delete_user_submit"===target.dataset.handler){let userid=target.dataset.userid,teamid=target.dataset.teamid;return Keyboardnav.setPrevfocusedElement('[data-userid="'.concat(userid,'"]')),void Str.get_strings([{key:"titlepopupremoveuser",component:"local_teamwork"},{key:"contentpopupremoveuser",component:"local_teamwork"},{key:"buttonpopupremoveuser",component:"local_teamwork"}]).done((function(strings){var modalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:strings[0],body:strings[1]});$.when(modalPromise).then((function(fmodal){fmodal.setSaveButtonText(strings[2]),fmodal.getRoot().on(ModalEvents.save,(function(e){e.preventDefault(),delete_user_submit(userid,teamid,courseid,activityid,moduletype,(function(){render.setDefaultData(),render.studentList(),render.teamsCard(),$(".skin.shadow").removeAttr("style"),fmodal.destroy()}))})),fmodal.getRoot().on(ModalEvents.cancel,(function(e){render.setDefaultData(),render.studentList(),render.teamsCard(),$(".skin.shadow").removeAttr("style"),fmodal.destroy(),Keyboardnav.setFocusOnPrevfocusedElement()}));var root=fmodal.getRoot();return root.on(ModalEvents.shown,(function(){$(".skin.shadow").css("z-index","1000")})),root.on(ModalEvents.hidden,(function(){render.setDefaultData(),render.studentList(),render.teamsCard(),$(".skin.shadow").removeAttr("style"),fmodal.destroy(),Keyboardnav.setFocusOnPrevfocusedElement()})),fmodal})).done((function(modal){modal.show()})).fail(Notification.exception)}))}if("get_popup_data"===target.dataset.handler)return event.preventDefault(),student_settings_popup_data(courseid,activityid,moduletype),popup.remove(),Keyboardnav.getFocusableElements(".teamworkdialog"),Keyboardnav.setAccessabilityBehaviuor(),void Keyboardnav.setFocusOnPrevfocusedElement();if("open_group_selection"===target.dataset.handler)return void $(target).next().slideToggle();if("select_groups"===target.dataset.handler){let text=document.querySelector('html[lang="en"]')?"choose grous":"בחר קבוצה";if(target.classList.contains("selected"))return;target.classList.toggle("selected"),$('div[data-handler="open_group_selection"]').html(target.classList.contains("selected")?target.innerHTML:text),$(target).siblings().removeClass("selected");let result=[];return Array.from(target.parentNode.children).forEach((item=>{item.classList.contains("selected")&&result.push(item.dataset.value)})),$(target).parent().slideToggle(),selectgroupid=JSON.stringify(result),render.data.selectgroupid=JSON.stringify(result),render.studentList(),void render.teamsCard()}if("add_new_teamcard"===target.dataset.handler)return void add_new_card(courseid,activityid,moduletype,selectgroupid,null,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}));if("delete_teamcard"===target.dataset.handler){let teamid=target.dataset.remove_team_id;return delete_card(teamid,0,0,0,(function(){render.setDefaultData(),render.teamsCard(),render.studentList()})),void Keyboardnav.setPrevfocusedElement('[data-handler="'.concat(target.dataset.handler,'"]'))}if("random_popup"===target.dataset.handler)return Ajax.call([{methodname:"local_teamwork_show_random_popup",args:{},done:function(data){let result=JSON.parse(data.result);popup.textHead=result.header,popup.text=result.content,popup.show(),Keyboardnav.getFocusableElements(".teamwork-modal"),Keyboardnav.setAccessabilityBehaviuor(),Keyboardnav.setFocusOnElement("#student_number")},fail:function(){popup.error()}}]),void Keyboardnav.setPrevfocusedElement('[data-handler="'.concat(target.dataset.handler,'"]'));if("random"===target.dataset.handler)return void set_random_teams(target,courseid,activityid,moduletype,render.data.selectgroupid,(function(){render.teamsCard(),render.studentList(),popup.remove()}));if("search_reset"===target.dataset.handler)return void searchReset();target=target.parentNode}})),$(document).on("keydown",".skin_close",(function(e){13===(e.keyCode?e.keyCode:e.which)&&(Voicecontrol.stop(),skin.remove())})),drag.startDrag(),document.addEventListener("change",(function(event){"input_team_name"===event.target.dataset.handler&&(set_new_team_name(event.target,0,0,0,render.data.selectgroupid,(function(){render.teamsCard()})),Keyboardnav.setPrevfocusedElement('[data-handler="'.concat(event.target.dataset.handler,'"]')))})),document.addEventListener("keypress",(function(event){"input_team_name"===event.target.dataset.handler&&13===event.keyCode&&set_new_team_name(event.target,0,0,0,render.data.selectgroupid,(function(){render.teamsCard()}))})),document.addEventListener("keydown",(function(event){27===event.keyCode&&(skin.remove(),popup.remove())}))}}}));

//# sourceMappingURL=init.min.js.map