define("local_teamwork/voicecontrol",["jquery","core/ajax"],(function($,Ajax){var timeout=4,timer=!1,timers=[],clear_all_timers=()=>{timers.forEach(((i,t)=>{clearInterval(i)})),timers=[],timer=!1};const start_timer=(duration,callback)=>{timer&&clear_all_timers();var countDownDate=(new Date).getTime()+1e3*duration,x=setInterval((function(){var now=(new Date).getTime(),distance=countDownDate-now;Math.floor(distance/864e5),Math.floor(distance%864e5/36e5),Math.floor(distance%36e5/6e4),Math.floor(distance%6e4/1e3);distance<0&&(clear_all_timers(),clearInterval(x),callback())}),1e3);timers.includes(x)||(timers.push(x),timer=!0)};var current_langcode="",current_short_langcode="",set_lang=function(){let lang=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en-US";current_langcode=lang,current_short_langcode=lang.split("-")[0]},tokens=[],schemes=[],commands=[],default_commands=[{public:!0,scheme:{},command_id:"sing_a_song",command_exec:()=>{sound("sample")},params:{}},{public:!0,command_id:"add_new_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){let courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid;l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,null,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"add_new_named_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){let courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid,teamname=params._teamname;l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,teamname,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"create_numbers_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){var number=text2num(params._number);let courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid;for(let index=0;index<number;index++)l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,null,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"drag_student_card",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var draguserid=params.userfullname,stud_card=$("div.teamwork_student[data-student_id="+draguserid+"]"),groupid=params.teamname;$("div.teamwork_team[data-team_id="+groupid+"]").find(".teamwork_team-inner.draggable").append(stud_card);const allTeamsBlocks=Array.from(document.querySelectorAll("div[data-team_id]")),allTeams=[];allTeamsBlocks.forEach((item=>{let team={};team.teamid=item.dataset.team_id,team.studentid=[],Array.from(item.querySelectorAll(".teamwork_student")).forEach((student=>{team.studentid.push(student.dataset.student_id)})),allTeams.push(team)}));let courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid,newteamspost=JSON.stringify(allTeams);draguserid=Number(draguserid),loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_drag_student_card",args:{courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,newteamspost:newteamspost,draguserid:draguserid,removeteam:!1},done:function(data){loadingIcon.remove(),render.setDefaultData(),render.studentList(),render.teamsCard()},fail:function(){loadingIcon.remove(),popup.error()}}])}))}},{public:!0,command_id:"delete_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading","local_teamwork/init"],(function(render,Ajax,loadingIcon,l_tw_init){var teamid=params.teamname;let courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype;l_tw_init.delete_card(teamid,courseid,activityid,moduletype,(function(){render.setDefaultData(),render.teamsCard(),render.studentList()}))}))}},{public:!0,command_id:"read_users",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var user_list="";params.students.forEach((element=>{user_list+=element.value+", "})),say(user_list)}))}},{public:!0,command_id:"read_teams",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var group_list="";params.groups.forEach((element=>{group_list+=element.value+", "})),say(group_list)}))}}];let get_commands=()=>{default_commands.forEach(((element,index)=>{var scheme_id=element.command_id;default_commands[index].scheme=schemes[scheme_id]})),commands=default_commands};var state="disabled";let similarity=(s1,s2)=>{var longer=s1,shorter=s2;s1.length<s2.length&&(longer=s2,shorter=s1);var longerLength=longer.length;return 0===longerLength?1:(longerLength-editDistance(longer,shorter))/parseFloat(longerLength)},editDistance=(s1,s2)=>{s1=s1.toLowerCase(),s2=s2.toLowerCase();for(var costs=new Array,i=0;i<=s1.length;i++){for(var lastValue=i,j=0;j<=s2.length;j++)if(0===i)costs[j]=j;else if(j>0){var newValue=costs[j-1];s1.charAt(i-1)!==s2.charAt(j-1)&&(newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1),costs[j-1]=lastValue,lastValue=newValue}i>0&&(costs[s2.length]=lastValue)}return costs[s2.length]};const stringSimilarity=(a,b)=>_stringSimilarity(prep(a),prep(b)),_stringSimilarity=(a,b)=>{const bg1=bigrams(a),bg2=bigrams(b),c1=count(bg1),c2=count(bg2);return 2*uniq([...bg1,...bg2]).reduce(((t,k)=>t+Math.min(c1[k]||0,c2[k]||0)),0)/(bg1.length+bg2.length)},prep=str=>"iw"!==current_short_langcode?str.toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," "):str.toLowerCase().replace("^[a-z֐-׾]+$"," "),bigrams=str=>[...str].slice(0,-1).map(((c,i)=>c+str[i+1])),count=xs=>xs.reduce(((a,x)=>(a[x]=(a[x]||0)+1,a)),{}),uniq=xs=>[...new Set(xs)];let find_match=function(input,stack){let threshold=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.35;var result=null,list=[];return input=input.toLowerCase(),stack.forEach(((element,index)=>{var el_weight=0,sim=0,scheme_option=0;("string"!=typeof element?element:[element]).forEach(((el,i)=>{(sim=stringSimilarity(input,el.toLowerCase().trim()))>el_weight&&(el_weight=sim,scheme_option=i)})),list.push([index,el_weight,scheme_option])})),list.sort(((a,b)=>b[1]-a[1])),(result=list[0])[1]<threshold?null:result};const extract=(template,str)=>{const templateParts=template.split(/{|}/),extracted={};for(let index=1;index<templateParts.length;index+=2){const possibleKey=templateParts[index],keyPrefix=templateParts[index-1],nextPrefix=templateParts[index+1],substringStartIndex=str.indexOf(keyPrefix)+keyPrefix.length,substringEndIndex=nextPrefix?str.indexOf(nextPrefix):str.length;extracted[possibleKey]=str.substring(substringStartIndex,substringEndIndex)}return extracted};var match_token=input=>{var match=!1;return tokens.some((function(el){input.includes(el)&&(match=!0)})),match?(speechRecognition.abort(),setTimeout((()=>{speechRecognition.start()}),500),sound("ready"),set_state("command"),update_status(input,"success"),!0):(update_status(input,"danger"),set_state("enabled"),!1)},match_command=input=>{var found=!1,commands_schemes=commands.map(((i,el)=>i.scheme)),index=find_match(input,commands_schemes);if(null!==index){var found_scheme=(found=commands[index[0]]).scheme[index[2]].trim();if(found.params.placeholders){var matched_params={},input_values=extract(found_scheme,input);let plhdrs=found.params.placeholders,arr_plhdrs=Object.entries(plhdrs);if(arr_plhdrs.forEach(((element,key)=>{var el_name=element[0],el_options=element[1];if(el_name.startsWith("_"))matched_params[el_name]=input_values[el_name];else{var list=el_options.map(((i,el)=>i.value)),match_index=find_match(input_values[el_name],list);null!==match_index&&(matched_params[el_name]=el_options[match_index[0]].id)}})),arr_plhdrs.length!==Object.entries(matched_params).length)return set_state("enabled"),sound("timeout"),!1;found.params={...found.params,...matched_params}}return found.command_exec(found.params),sound("correct"),set_state("enabled"),update_status(input,"success"),!0}return say(strings[current_short_langcode].unknown_command+': "'+input+'"'),set_state("enabled"),update_status(input,"danger"),sound("timeout"),!1},sound=type=>{const audio=new Audio(eval(type+"_sound_path"));audio.play()},cancel=!1,say=text=>{speechRecognition&&speechRecognition.stop();var msg=new SpeechSynthesisUtterance,lang_for_speech="";if("iw"===current_short_langcode)lang_for_speech="he";else{lang_for_speech=/[\u0590-\u05FF]/.test(text)?"he":current_short_langcode}msg.lang=lang_for_speech,msg.onend=function(e){cancel?(document.querySelector("#vc-start").style.display="block",document.querySelector("#vc-stop").style.display="none",cancel=!1):(speechRecognition.start(),document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block")},msg.onstart=function(e){document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block"},msg.text=text,speechSynthesis.speak(msg)},last_said=[],said_count=0;let update_status=function(info){let type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";last_said.push({id:said_count,type:type,info:info}),said_count++,render_status()},render_status=function(){let length=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;var html=$("<div>");last_said.sort((function(a,b){return a.id<b.id?1:a.id>b.id?-1:0}));var count=0;for(const element of last_said){var txt=$("<div></div>").html(element.info).addClass("mb-0 p-1 h4 alert alert-"+element.type);if(html.append(txt),++count>=length)break}let last=last_said[0];$("#vc-status").html($("<div></div>").html(last.info).addClass("mb-0 p-1 h4 alert alert-"+last.type)),$("#vc-status").attr("data-original-title",html.html())};var available_commands=[];let update_commands=()=>{available_commands=[],commands.forEach((element=>{element.public&&available_commands.push(element)})),render_commands()},help_string={en:'Please say "OK"',ru:'Пожалуйста скажите "ОК"',iw:'נא להגידת "אוקיי פטל"'},list_of_orders_title={en:"List of orders",ru:"Список комманд",iw:"פקודות קוליות"},strings={en:{unknown_command:"Unknown command"},ru:{unknown_command:"Неизвестная комманда"},iw:{unknown_command:"פקודה לא מזוהה"}},render_commands=()=>{var html=$("<div>"),txt=$("<div></div>").html(help_string[current_short_langcode]).addClass("h2");html.append(txt);txt=$("<div></div>").html(list_of_orders_title[current_short_langcode]).addClass("h3");html.append(txt),available_commands.forEach((element=>{var txt=$("<div></div>").html(element.scheme.join("<br>")).addClass("alert alert-info");html.append(txt)})),$("#vc-commands-help").attr("data-content",html.html())};var set_state=input_state=>{switch(input_state){case"enabled":case"disabled":clear_all_timers();break;case"command":start_timer(timeout,(()=>{set_state("enabled"),sound("timeout")}))}state=input_state},grammararray=[];let collect_grammar=()=>{grammararray=grammararray.concat(tokens.join(" ")),commands.forEach((element=>{grammararray=grammararray.concat(element.scheme.join(" "))})),grammararray=[...new Set(grammararray)]};set_state("enabled");var start_button=document.querySelector("#vc-start"),stop_button=document.querySelector("#vc-stop"),speechRecognition;function init_vtt(){if("webkitSpeechRecognition"in window){speechRecognition=new webkitSpeechRecognition;var SpeechGrammarList=SpeechGrammarList||window.webkitSpeechGrammarList;if(SpeechGrammarList){var speechRecognitionList=new SpeechGrammarList,grammar="#JSGF V1.0; grammar commands; public <command> = "+grammararray.join(" | ")+" ;";speechRecognitionList.addFromString(grammar,1),speechRecognition.grammars=speechRecognitionList}speechRecognition.maxAlternatives=1,speechRecognition.continuous=!0,speechRecognition.interimResults=!0,speechRecognition.lang=current_langcode;let final_transcript="";speechRecognition.onstart=()=>{document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block"},speechRecognition.onerror=e=>{speechRecognition.start()},speechRecognition.onend=()=>{start_button&&(start_button.style.display="block"),stop_button&&(stop_button.style.display="none"),document.querySelector("#vc-start").style.display="block",document.querySelector("#vc-stop").style.display="none",cancel||speechRecognition.start()},speechRecognition.onresult=event=>{let interim_transcript="";for(let i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal?(final_transcript=event.results[i][0].transcript.trim(),"enabled"===state||"command"===state&&match_command(final_transcript)):(interim_transcript=event.results[i][0].transcript.trim(),"enabled"===state&&match_token(interim_transcript),"command"===state&&start_timer(timeout,(()=>{set_state("enabled"),sound("timeout")})))},listeners()}}let listeners=()=>{$(document).on("click","#vc-start",(function(){speechRecognition.start()})),$(document).on("click","#vc-stop",(function(){cancel=!0,speechRecognition&&(speechRecognition.stop(),speechSynthesis.cancel())}))};var ready_sound_path="",correct_sound_path="",timeout_sound_path="",please_repeat_sound_path="",sample_sound_path="",Small={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,"אחד":1,"אחת":1,"שני":2,"שתיים":2,"שלושת":3,"שלוש":3,"ארבעת":4,"ארבע":4,"חמשת":5,"חמש":5,"ששת":6,"שש":6,"שבעת":7,"שבע":7,"שמונת":8,"שְמוֹנֶה":8,"תשעת":9,"תשע":9,"עשרת":10,"עשר":10},Magnitude={thousand:1e3,million:1e6,billion:1e9,trillion:1e12,quadrillion:1e15,quintillion:1e18,sextillion:1e21,septillion:1e24,octillion:1e27,nonillion:1e30,decillion:1e33},a,n,g;function text2num(s){return a=s.toString().split(/[\s-]+/),n=0,g=0,a.forEach(feach),n+g}function feach(w){var x=Small[w];null!=x?g+=x:"hundred"===w?g*=100:null!=(x=Magnitude[w])?(n+=g*x,g=0):null!=w&&(g=w)}return{reinit:function(){reinit()},init:function(currentlangcode,paths,inputtokens,inputschemes){ready_sound_path=paths[0],correct_sound_path=paths[1],timeout_sound_path=paths[2],please_repeat_sound_path=paths[3],sample_sound_path=paths[4],tokens=inputtokens,schemes=inputschemes,set_lang(currentlangcode),init_vtt()},stop:function(){speechRecognition&&speechRecognition.stop()},init_listeners:function(){listeners()},update_commands:function(){get_commands(),update_commands()},reload:function(courseid,activityid,moduletype,selectgroupid){$("body").on("DOMSubtreeModified","#teamwork",(function(){var groups=[],groups_elements=$("input[data-handler='input_team_name']");Array.from(groups_elements).forEach((element=>{groups.push({id:element.dataset.team_id,value:element.value})}));var all_students=[],students_elements=$("div.teamwork_student");Array.from(students_elements).forEach((element=>{all_students.push({id:element.dataset.student_id,value:element.innerText})}));var avail_students=[];students_elements=$("#studentList div.teamwork_student");Array.from(students_elements).forEach((element=>{avail_students.push({id:element.dataset.student_id,value:element.innerText})}));var index=default_commands.map((e=>e.command_id)).indexOf("add_new_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid};index=default_commands.map((e=>e.command_id)).indexOf("add_new_named_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{_teamname:null}};index=default_commands.map((e=>e.command_id)).indexOf("create_numbers_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{_number:null}};index=default_commands.map((e=>e.command_id)).indexOf("drag_student_card");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{userfullname:all_students,teamname:groups}};index=default_commands.map((e=>e.command_id)).indexOf("delete_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{teamname:groups}};index=default_commands.map((e=>e.command_id)).indexOf("read_users");default_commands[index].params={students:avail_students};index=default_commands.map((e=>e.command_id)).indexOf("read_teams");default_commands[index].params={groups:groups}}))}}}));

//# sourceMappingURL=voicecontrol.min.js.map