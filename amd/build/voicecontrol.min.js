function _createForOfIteratorHelper(o,allowArrayLike){var it="undefined"!=typeof Symbol&&o[Symbol.iterator]||o["@@iterator"];if(!it){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"==typeof o.length){it&&(o=it);var i=0,F=function(){};return{s:F,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var err,normalCompletion=!0,didErr=!1;return{s:function(){it=it.call(o)},n:function(){var step=it.next();return normalCompletion=step.done,step},e:function(_e2){didErr=!0,err=_e2},f:function(){try{normalCompletion||null==it.return||it.return()}finally{if(didErr)throw err}}}}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}))),keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach((function(key){_defineProperty(target,key,source[key])})):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}return target}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_unsupportedIterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _iterableToArray(iter){if("undefined"!=typeof Symbol&&null!=iter[Symbol.iterator]||null!=iter["@@iterator"])return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}define("local_teamwork/voicecontrol",["jquery","core/ajax"],(function($,Ajax){var timeout=4,timer=!1,timers=[],clear_all_timers=function(){timers.forEach((function(i,t){clearInterval(i)})),timers=[],timer=!1},start_timer=function(duration,callback){timer&&clear_all_timers();var countDownDate=(new Date).getTime()+1e3*duration,x=setInterval((function(){var now=(new Date).getTime(),distance=countDownDate-now;Math.floor(distance/864e5),Math.floor(distance%864e5/36e5),Math.floor(distance%36e5/6e4),Math.floor(distance%6e4/1e3);distance<0&&(clear_all_timers(),clearInterval(x),callback())}),1e3);timers.includes(x)||(timers.push(x),timer=!0)},current_langcode="",current_short_langcode="",set_lang=function(){var lang=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en-US";current_langcode=lang,current_short_langcode=lang.split("-")[0]},tokens=[],schemes=[],commands=[],default_commands=[{public:!0,scheme:{},command_id:"sing_a_song",command_exec:function(){sound("sample")},params:{}},{public:!0,command_id:"add_new_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){var courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid;l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,null,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"add_new_named_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){var courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid,teamname=params._teamname;l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,teamname,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"create_numbers_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","local_teamwork/init"],(function(render,l_tw_init){for(var number=text2num(params._number),courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid,index=0;index<number;index++)l_tw_init.add_new_card(courseid,activityid,moduletype,selectgroupid,null,(function(){render.setDefaultData(),render.studentList(),render.teamsCard()}))}))}},{public:!0,command_id:"drag_student_card",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var draguserid=params.userfullname,stud_card=$("div.teamwork_student[data-student_id="+draguserid+"]"),groupid=params.teamname;$("div.teamwork_team[data-team_id="+groupid+"]").find(".teamwork_team-inner.draggable").append(stud_card);var allTeamsBlocks=Array.from(document.querySelectorAll("div[data-team_id]")),allTeams=[];allTeamsBlocks.forEach((function(item){var team={};team.teamid=item.dataset.team_id,team.studentid=[],Array.from(item.querySelectorAll(".teamwork_student")).forEach((function(student){team.studentid.push(student.dataset.student_id)})),allTeams.push(team)}));var courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype,selectgroupid=params.selectgroupid,newteamspost=JSON.stringify(allTeams);draguserid=Number(draguserid),loadingIcon.show(),Ajax.call([{methodname:"local_teamwork_drag_student_card",args:{courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,newteamspost:newteamspost,draguserid:draguserid,removeteam:!1},done:function(data){loadingIcon.remove(),render.setDefaultData(),render.studentList(),render.teamsCard()},fail:function(){loadingIcon.remove(),popup.error()}}])}))}},{public:!0,command_id:"delete_teamcard",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading","local_teamwork/init"],(function(render,Ajax,loadingIcon,l_tw_init){var teamid=params.teamname,courseid=params.courseid,activityid=params.activityid,moduletype=params.moduletype;l_tw_init.delete_card(teamid,courseid,activityid,moduletype,(function(){render.setDefaultData(),render.teamsCard(),render.studentList()}))}))}},{public:!0,command_id:"read_users",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var user_list="";params.students.forEach((function(element){user_list+=element.value+", "})),say(user_list)}))}},{public:!0,command_id:"read_teams",scheme:{},params:{},command_exec:function(params){require(["local_teamwork/render","core/ajax","local_teamwork/loading"],(function(render,Ajax,loadingIcon){var group_list="";params.groups.forEach((function(element){group_list+=element.value+", "})),say(group_list)}))}}],get_commands=function(){default_commands.forEach((function(element,index){var scheme_id=element.command_id;default_commands[index].scheme=schemes[scheme_id]})),commands=default_commands},state="disabled",similarity=function(s1,s2){var longer=s1,shorter=s2;s1.length<s2.length&&(longer=s2,shorter=s1);var longerLength=longer.length;return 0==longerLength?1:(longerLength-editDistance(longer,shorter))/parseFloat(longerLength)},editDistance=function(s1,s2){s1=s1.toLowerCase(),s2=s2.toLowerCase();for(var costs=new Array,i=0;i<=s1.length;i++){for(var lastValue=i,j=0;j<=s2.length;j++)if(0==i)costs[j]=j;else if(j>0){var newValue=costs[j-1];s1.charAt(i-1)!=s2.charAt(j-1)&&(newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1),costs[j-1]=lastValue,lastValue=newValue}i>0&&(costs[s2.length]=lastValue)}return costs[s2.length]},stringSimilarity=function(a,b){return _stringSimilarity(prep(a),prep(b))},_stringSimilarity=function(a,b){var bg1=bigrams(a),bg2=bigrams(b),c1=count(bg1),c2=count(bg2);return 2*uniq([].concat(_toConsumableArray(bg1),_toConsumableArray(bg2))).reduce((function(t,k){return t+Math.min(c1[k]||0,c2[k]||0)}),0)/(bg1.length+bg2.length)},prep=function(str){return"iw"!=current_short_langcode?str.toLowerCase().replace(/[^\w\s]/g," ").replace(/\s+/g," "):str.toLowerCase().replace("^[a-z֐-׾]+$"," ")},bigrams=function(str){return _toConsumableArray(str).slice(0,-1).map((function(c,i){return c+str[i+1]}))},count=function(xs){return xs.reduce((function(a,x){return a[x]=(a[x]||0)+1,a}),{})},uniq=function(xs){return _toConsumableArray(new Set(xs))},find_match=function(input,stack){var threshold=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.35,result=null,list=[];return input=input.toLowerCase(),stack.forEach((function(element,index){var el_weight=0,sim=0,scheme_option=0;("string"!=typeof element?element:[element]).forEach((function(el,i){(sim=stringSimilarity(input,el.toLowerCase().trim()))>el_weight&&(el_weight=sim,scheme_option=i)})),list.push([index,el_weight,scheme_option])})),list.sort((function(a,b){return b[1]-a[1]})),(result=list[0])[1]<threshold?null:result},extract=function(template,str){for(var templateParts=template.split(/{|}/),extracted={},index=1;index<templateParts.length;index+=2){var possibleKey=templateParts[index],keyPrefix=templateParts[index-1],nextPrefix=templateParts[index+1],substringStartIndex=str.indexOf(keyPrefix)+keyPrefix.length,substringEndIndex=nextPrefix?str.indexOf(nextPrefix):str.length;extracted[possibleKey]=str.substring(substringStartIndex,substringEndIndex)}return extracted},match_token=function(input){var match=!1;return tokens.some((function(el){input.includes(el)&&(match=!0)})),match?(console.log("speechRecognition"),console.log(speechRecognition),console.log("speechRecognition STOP"),speechRecognition.abort(),setTimeout((function(){speechRecognition.start(),console.log("speechRecognition START")}),500),sound("ready"),set_state("command"),update_status(input,"success"),!0):(update_status(input,"danger"),set_state("enabled"),!1)},match_command=function(input){var found=!1,commands_schemes=commands.map((function(i,el){return i.scheme})),index=find_match(input,commands_schemes);if(null!==index){var found_scheme=(found=commands[index[0]]).scheme[index[2]].trim();if(found.params.placeholders){var matched_params={},input_values=extract(found_scheme,input),plhdrs=found.params.placeholders,arr_plhdrs=Object.entries(plhdrs);if(arr_plhdrs.forEach((function(element,key){var el_name=element[0],el_options=element[1];if(el_name.startsWith("_"))matched_params[el_name]=input_values[el_name];else{var list=el_options.map((function(i,el){return i.value})),match_index=find_match(input_values[el_name],list);null!==match_index&&(matched_params[el_name]=el_options[match_index[0]].id)}})),arr_plhdrs.length!=Object.entries(matched_params).length)return set_state("enabled"),sound("timeout"),!1;found.params=_objectSpread(_objectSpread({},found.params),matched_params)}return found.command_exec(found.params),sound("correct"),set_state("enabled"),update_status(input,"success"),!0}return say(strings[current_short_langcode].unknown_command+': "'+input+'"'),set_state("enabled"),update_status(input,"danger"),sound("timeout"),!1},sound=function sound(type){var audio=new Audio(eval(type+"_sound_path"));audio.play()},cancel=!1,say=function(text){speechRecognition&&speechRecognition.stop();var msg=new SpeechSynthesisUtterance,lang_for_speech="";if("iw"==current_short_langcode)lang_for_speech="he";else{lang_for_speech=/[\u0590-\u05FF]/.test(text)?"he":current_short_langcode}msg.lang=lang_for_speech,msg.onend=function(e){cancel?(document.querySelector("#vc-start").style.display="block",document.querySelector("#vc-stop").style.display="none",cancel=!1):(speechRecognition.start(),document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block")},msg.onstart=function(e){document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block"},msg.text=text,speechSynthesis.speak(msg)},last_said=[],said_count=0,update_status=function(info){var type=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";last_said.push({id:said_count,type:type,info:info}),said_count++,render_status()},render_status=function(){var length=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,html=$("<div>");last_said.sort((function(a,b){return a.id<b.id?1:a.id>b.id?-1:0}));var _step,count=0,_iterator=_createForOfIteratorHelper(last_said);try{for(_iterator.s();!(_step=_iterator.n()).done;){var element=_step.value,txt=$("<div></div>").html(element.info).addClass("mb-0 p-1 h4 alert alert-"+element.type);if(html.append(txt),++count>=length)break}}catch(err){_iterator.e(err)}finally{_iterator.f()}var last=last_said[0];$("#vc-status").html($("<div></div>").html(last.info).addClass("mb-0 p-1 h4 alert alert-"+last.type)),$("#vc-status").attr("data-original-title",html.html())},available_commands=[],_update_commands=function(){available_commands=[],commands.forEach((function(element){element.public&&available_commands.push(element)})),render_commands()},help_string={en:'Please say "OK"',ru:'Пожалуйста скажите "ОК"',iw:'נא להגידת "אוקיי פטל"'},list_of_orders_title={en:"List of orders",ru:"Список комманд",iw:"פקודות קוליות"},strings={en:{unknown_command:"Unknown command"},ru:{unknown_command:"Неизвестная комманда"},iw:{unknown_command:"פקודה לא מזוהה"}},render_commands=function(){var html=$("<div>"),txt=$("<div></div>").html(help_string[current_short_langcode]).addClass("h2");html.append(txt);txt=$("<div></div>").html(list_of_orders_title[current_short_langcode]).addClass("h3");html.append(txt),available_commands.forEach((function(element){var txt=$("<div></div>").html(element.scheme.join("<br>")).addClass("alert alert-info");html.append(txt)})),$("#vc-commands-help").attr("data-content",html.html())},set_state=function set_state(input_state){switch(input_state){case"enabled":case"disabled":clear_all_timers();break;case"command":start_timer(timeout,(function(){set_state("enabled"),sound("timeout")}))}state=input_state},grammararray=[],collect_grammar=function(){grammararray=grammararray.concat(tokens.join(" ")),commands.forEach((function(element){grammararray=grammararray.concat(element.scheme.join(" "))})),grammararray=_toConsumableArray(new Set(grammararray))};set_state("enabled");var start_button=document.querySelector("#vc-start"),stop_button=document.querySelector("#vc-stop"),speechRecognition;function init_vtt(){if("webkitSpeechRecognition"in window){speechRecognition=new webkitSpeechRecognition;var SpeechGrammarList=SpeechGrammarList||window.webkitSpeechGrammarList;if(SpeechGrammarList){var speechRecognitionList=new SpeechGrammarList,grammar="#JSGF V1.0; grammar commands; public <command> = "+grammararray.join(" | ")+" ;";speechRecognitionList.addFromString(grammar,1),speechRecognition.grammars=speechRecognitionList}speechRecognition.maxAlternatives=1,speechRecognition.continuous=!0,speechRecognition.interimResults=!0,speechRecognition.lang=current_langcode;var final_transcript="";speechRecognition.onstart=function(){document.querySelector("#vc-start").style.display="none",document.querySelector("#vc-stop").style.display="block"},speechRecognition.onerror=function(e){speechRecognition.start()},speechRecognition.onend=function(){start_button&&(start_button.style.display="block"),stop_button&&(stop_button.style.display="none"),document.querySelector("#vc-start").style.display="block",document.querySelector("#vc-stop").style.display="none",cancel||speechRecognition.start()},speechRecognition.onresult=function(event){for(var interim_transcript="",i=event.resultIndex;i<event.results.length;++i)event.results[i].isFinal?(final_transcript=event.results[i][0].transcript.trim(),"enabled"==state||"command"==state&&match_command(final_transcript)):(interim_transcript=event.results[i][0].transcript.trim(),console.log(interim_transcript),"enabled"==state&&match_token(interim_transcript),"command"==state&&start_timer(timeout,(function(){set_state("enabled"),sound("timeout")})))},listeners()}}var listeners=function(){$(document).on("click","#vc-start",(function(){speechRecognition.start()})),$(document).on("click","#vc-stop",(function(){cancel=!0,speechRecognition&&(speechRecognition.stop(),speechSynthesis.cancel())}))},ready_sound_path="",correct_sound_path="",timeout_sound_path="",please_repeat_sound_path="",sample_sound_path="",Small={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,"אחד":1,"אחת":1,"שני":2,"שתיים":2,"שלושת":3,"שלוש":3,"ארבעת":4,"ארבע":4,"חמשת":5,"חמש":5,"ששת":6,"שש":6,"שבעת":7,"שבע":7,"שמונת":8,"שְמוֹנֶה":8,"תשעת":9,"תשע":9,"עשרת":10,"עשר":10},Magnitude={thousand:1e3,million:1e6,billion:1e9,trillion:1e12,quadrillion:1e15,quintillion:1e18,sextillion:1e21,septillion:1e24,octillion:1e27,nonillion:1e30,decillion:1e33},a,n,g;function text2num(s){return a=s.toString().split(/[\s-]+/),n=0,g=0,a.forEach(feach),n+g}function feach(w){var x=Small[w];null!=x?g+=x:"hundred"==w?g*=100:null!=(x=Magnitude[w])?(n+=g*x,g=0):null!=w&&(g=w)}return{reinit:function(_reinit){function reinit(){return _reinit.apply(this,arguments)}return reinit.toString=function(){return _reinit.toString()},reinit}((function(){reinit()})),init:function(currentlangcode,paths,inputtokens,inputschemes){ready_sound_path=paths[0],correct_sound_path=paths[1],timeout_sound_path=paths[2],please_repeat_sound_path=paths[3],sample_sound_path=paths[4],tokens=inputtokens,schemes=inputschemes,set_lang(currentlangcode),init_vtt()},stop:function(){speechRecognition&&speechRecognition.stop()},init_listeners:function(){listeners()},update_commands:function(){get_commands(),_update_commands()},reload:function(courseid,activityid,moduletype,selectgroupid){$("body").on("DOMSubtreeModified","#teamwork",(function(){var groups=[],groups_elements=$("input[data-handler='input_team_name']");Array.from(groups_elements).forEach((function(element){groups.push({id:element.dataset.team_id,value:element.value})}));var all_students=[],students_elements=$("div.teamwork_student");Array.from(students_elements).forEach((function(element){all_students.push({id:element.dataset.student_id,value:element.innerText})}));var avail_students=[];students_elements=$("#studentList div.teamwork_student");Array.from(students_elements).forEach((function(element){avail_students.push({id:element.dataset.student_id,value:element.innerText})}));var index=default_commands.map((function(e){return e.command_id})).indexOf("add_new_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid};index=default_commands.map((function(e){return e.command_id})).indexOf("add_new_named_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{_teamname:null}};index=default_commands.map((function(e){return e.command_id})).indexOf("create_numbers_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{_number:null}};index=default_commands.map((function(e){return e.command_id})).indexOf("drag_student_card");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{userfullname:all_students,teamname:groups}};index=default_commands.map((function(e){return e.command_id})).indexOf("delete_teamcard");default_commands[index].params={courseid:courseid,activityid:activityid,moduletype:moduletype,selectgroupid:selectgroupid,placeholders:{teamname:groups}};index=default_commands.map((function(e){return e.command_id})).indexOf("read_users");default_commands[index].params={students:avail_students};index=default_commands.map((function(e){return e.command_id})).indexOf("read_teams");default_commands[index].params={groups:groups}}))}}}));

//# sourceMappingURL=voicecontrol.min.js.map